(()=>{"use strict";var e,t,s,i;!function(e){e[e.Empty=0]="Empty",e[e.Hand=1]="Hand",e[e.Pistol=2]="Pistol",e[e.Machinegun=3]="Machinegun",e[e.Shotgun=4]="Shotgun",e[e.Rifle=5]="Rifle",e[e.Hammer=6]="Hammer",e[e.Granade=7]="Granade",e[e.Smoke=8]="Smoke",e[e.Medkit=9]="Medkit"}(e||(e={})),function(e){e[e.Grass=0]="Grass",e[e.Water=1]="Water",e[e.WaterTriangle1=2]="WaterTriangle1",e[e.WaterTriangle2=3]="WaterTriangle2",e[e.WaterTriangle3=4]="WaterTriangle3",e[e.WaterTriangle4=5]="WaterTriangle4"}(t||(t={}));class a{constructor(e,s,i,a){switch(this.angle=0,this.type=e,this.x=s,this.y=i,this.size=a,e){case t.WaterTriangle2:this.angle=90;break;case t.WaterTriangle3:this.angle=180;break;case t.WaterTriangle4:this.angle=270}}}class n{constructor(e,t,s,i){this.changed=!1,this.opacity=1,this.active=!0,this.id=e,this.x=t,this.y=s,this.size=i,this.radius=i/2}getChanged(){return this.changed}nullChanged(){this.changed=!1}update(e){this.opacity=e}isPointIn(e){const t=this.x+this.radius-e.x,s=this.y+this.radius-e.y;return Math.sqrt(t*t+s*s)<=this.radius}getCenterX(){return this.x+this.size/2}getCenterY(){return this.y+this.size/2}getOpacity(){return this.opacity}isActive(){return this.active}}class r extends n{constructor(e,t,s,i){super(e,t,s,500),this.treeTrankRadius=35,this.angle=i}}class o extends n{constructor(e,t,s){super(e,t,s,100),this.opacity=1}}class h extends n{constructor(e,t,s,i){super(e,t,s,350),this.angle=i}}class l{constructor(e,t,s,i,a){this.changed=!1,this.opacity=1,this.active=!0,this.id=e,this.x=t,this.y=s,this.width=i,this.height=a}getChanged(){return this.changed}nullChanged(){this.changed=!1}getChangedData(){return{id:this.id,opacity:this.opacity}}update(e){this.opacity=e}isPointIn(e){const{x:t,y:s}=e;return t<this.x+this.width&&t>=this.x&&s>=this.y&&s<this.y+this.height}getOpacity(){return this.opacity}isActive(){return this.active}acceptHit(){this.active&&(this.opacity>.1&&(this.opacity-=.1),this.opacity<.1&&(this.active=!1),this.changed=!0)}}class c extends l{constructor(e,t,s,i,a){super(e,t,s,i,a)}}class m{constructor(){this.water="#69A2E0",this.grass="#A2CB69",this.blockFrame="gray",this.blockFrameActive="red",this.bullet="red",this.text="white",this.collisionPoint="red",this.player="#FFC878",this.hand="#FFC878",this.handBorder="#424242",this.vest="#424242",this.waterCircle="#2871C1"}}class g{constructor(e,t,s,i){this.active=!0,this.age=0,this.maxAge=10,this.startX=e,this.startY=t,this.endX=s,this.endY=i}increaseAge(){this.age++===this.maxAge&&(this.active=!1)}isActive(){return this.active}getAge(){return this.age}}class d{constructor(e,t,s){this.parts=[],this.id=e,this.startX=t,this.startY=s}setEnd(e,t){let s=this.startX,i=this.startY;this.parts.length&&(s=this.parts[this.parts.length-1].endX,i=this.parts[this.parts.length-1].endY),this.parts.push(new g(s,i,e,t))}isActive(){return!this.parts.length||this.parts[this.parts.length-1].isActive()}}class p{constructor(e,t){this.x=e,this.y=t}}!function(e){e[e.Pistol=0]="Pistol",e[e.Machinegun=1]="Machinegun",e[e.Shotgun=2]="Shotgun",e[e.Rifle=3]="Rifle",e[e.Hammer=4]="Hammer",e[e.RedAmmo=5]="RedAmmo",e[e.GreenAmmo=6]="GreenAmmo",e[e.BlueAmmo=7]="BlueAmmo",e[e.OrangeAmmo=8]="OrangeAmmo",e[e.Vest=9]="Vest",e[e.Medkit=10]="Medkit",e[e.Granade=11]="Granade",e[e.Smoke=12]="Smoke",e[e.Scope2=13]="Scope2",e[e.Scope4=14]="Scope4",e[e.Scope6=15]="Scope6"}(s||(s={}));class y{constructor(){this.loadingMax=40,this.loading=this.loadingMax,this.scope=.3,this.scopeLoadingChange=0,this.scopeResolutionAdjustment=.3}setScope(e){switch(e){case 2:e=1.2;break;case 4:e=1.4;break;case 6:e=1.6}const t=this.scope;this.scope=e,e!==t&&(this.scopeLoadingChange=(e-t)/this.loadingMax,this.loading=0)}getFinalResolutionAdjustment(e){return this.loading!==this.loadingMax&&(this.scopeResolutionAdjustment+=this.scopeLoadingChange,this.loading++),e/this.scopeResolutionAdjustment}}class u{constructor(e,t,s,i,a,n){this.resolutionAdjustment=1,this.finalResolutionAdjustment=1,this.bulletLines=[],this.lastdrawTime=Date.now(),this.scope=new y,this.snapshotManager=n,this.colors=new m,this.myHtmlElements=i,this.map=e,this.collisionPoints=a,this.mouse=t,this.gameScreen=this.myHtmlElements.gameScreen,this.editorScreen=this.myHtmlElements.editor.screen,this.mapScreen=this.myHtmlElements.mapScreen,this.helperScreen=this.myHtmlElements.helperScreen,this.ctxGame=this.gameScreen.getContext("2d"),this.ctxMap=this.mapScreen.getContext("2d"),this.ctxEditor=this.editorScreen.getContext("2d"),this.horizontalWallSVG=new Image,this.horizontalWallSVG.src="img/horizontalWall.svg",this.verticalWallSVG=new Image,this.verticalWallSVG.src="img/verticalWall.svg",this.bushSVG=new Image,this.bushSVG.src="img/bush.svg",this.rockSVG=new Image,this.rockSVG.src="img/rock.svg",this.treeSVG=new Image,this.treeSVG.src="img/tree.svg",this.cursorSVG=new Image,this.cursorSVG.src="img/cursor.svg",this.loadingProgresSVG=new Image,this.loadingProgresSVG.src="img/loadingProgres.svg",this.loadingCircleSVG=new Image,this.loadingCircleSVG.src="img/loadingCircle.svg",this.pistolSVG=new Image,this.pistolSVG.src="img/pistol.svg",this.machinegunSVG=new Image,this.machinegunSVG.src="img/machinegun.svg",this.rifleSVG=new Image,this.rifleSVG.src="img/rifle.svg",this.shotgunSVG=new Image,this.shotgunSVG.src="img/shotgun.svg",this.hammerSVG=new Image,this.hammerSVG.src="img/hammer.svg",this.granadeSVG=new Image,this.granadeSVG.src="img/granade.svg",this.smokeSVG=new Image,this.smokeSVG.src="img/smoke.svg",this.medkitSVG=new Image,this.medkitSVG.src="img/medkit.svg",this.smokeCloudSVG=new Image,this.smokeCloudSVG.src="img/smokeCloud.svg",this.rifleLootSVG=new Image,this.rifleLootSVG.src="img/rifleLoot.svg",this.pistolLootSVG=new Image,this.pistolLootSVG.src="img/pistolLoot.svg",this.shotgunLootSVG=new Image,this.shotgunLootSVG.src="img/shotgunLoot.svg",this.machinegunLootSVG=new Image,this.machinegunLootSVG.src="img/machinegunLoot.svg",this.hammerLootSVG=new Image,this.hammerLootSVG.src="img/hammerLoot.svg",this.granadeLootSVG=new Image,this.granadeLootSVG.src="img/granadeLoot.svg",this.smokeLootSVG=new Image,this.smokeLootSVG.src="img/smokeLoot.svg",this.redAmmoLootSVG=new Image,this.redAmmoLootSVG.src="img/redAmmoLoot.svg",this.greenAmmoLootSVG=new Image,this.greenAmmoLootSVG.src="img/greenAmmoLoot.svg",this.blueAmmoLootSVG=new Image,this.blueAmmoLootSVG.src="img/blueAmmoLoot.svg",this.orangeAmmoLootSVG=new Image,this.orangeAmmoLootSVG.src="img/orangeAmmoLoot.svg",this.medkitLootSVG=new Image,this.medkitLootSVG.src="img/medkitLoot.svg",this.vestLootSVG=new Image,this.vestLootSVG.src="img/vestLoot.svg",this.scope2LootSVG=new Image,this.scope2LootSVG.src="img/scope2Loot.svg",this.scope4LootSVG=new Image,this.scope4LootSVG.src="img/scope4Loot.svg",this.scope6LootSVG=new Image,this.scope6LootSVG.src="img/scope6Loot.svg",this.deadPlayer=new Image,this.deadPlayer.src="img/deadPlayer.svg",this.waterTrianglePNG=new Image,this.waterTrianglePNG.src="img/waterTriangle.png",this.waterTerrainData=s,this.screenResize()}reset(){this.myPlayer=null,this.scope=new y}screenResize(){const e=this.myHtmlElements;this.gameScreen.width=window.innerWidth,this.gameScreen.height=window.innerHeight,e.zoneSVG.setAttribute("width",window.innerWidth.toString()),e.zoneSVG.setAttribute("height",window.innerHeight.toString());const t=Math.floor((window.innerWidth/5+window.innerHeight/5)/2);this.mapScreen.width=t,this.mapScreen.height=t,e.mapZoneSVG.setAttribute("width",t.toString()),e.mapZoneSVG.setAttribute("height",t.toString()),e.mapContainer.style.width=(t+10).toString()+"px",e.mapContainer.style.height=(t+10).toString()+"px",this.screenCenterX=window.innerWidth/2,this.screenCenterY=window.innerHeight/2,this.changeResolutionAdjustment(),this.myPlayer&&this.drawGame(this.myPlayer.id)}calculateServerPosition(e){let t,s;return t=this.screenCenterX>e.x?-1*(this.screenCenterX-e.x):e.x-this.screenCenterX,s=this.screenCenterY>e.y?-1*(this.screenCenterY-e.y):e.y-this.screenCenterY,t/=this.finalResolutionAdjustment,s/=this.finalResolutionAdjustment,t+=this.myPlayer.getCenterX(),s+=this.myPlayer.getCenterY(),new p(t,s)}changeResolutionAdjustment(){const e=(this.gameScreen.width/1920+this.gameScreen.height/1050)/2;this.resolutionAdjustment=e}saveWaterPixels(e){const s=this.helperScreen.getContext("2d");this.helperScreen.width=this.waterTrianglePNG.width,this.helperScreen.height=this.waterTrianglePNG.height,s.fillStyle="#FFFFFF",s.fillRect(0,0,this.helperScreen.width,this.helperScreen.height);let i=this.waterTrianglePNG.width/2;switch(s.save(),s.translate(i,i),e){case t.WaterTriangle1:s.rotate(0*Math.PI/180);break;case t.WaterTriangle2:s.rotate(90*Math.PI/180);break;case t.WaterTriangle3:s.rotate(180*Math.PI/180);break;case t.WaterTriangle4:s.rotate(270*Math.PI/180)}if(s.drawImage(this.waterTrianglePNG,-i,-i),s.restore(),"undefined"!=typeof Worker){const t=new Worker("js/workerFindWater.js");t.onmessage=e=>{this.waterTerrainData.setData(e.data.type,e.data.data)};const i=s.getImageData(0,0,this.waterTrianglePNG.width,this.waterTrianglePNG.height).data;t.postMessage({data:i,size:this.waterTrianglePNG.width,type:e,time:(new Date).getTime()})}else console.log("err: Your browser doesn't support web workers.")}drawMap(){const e=this.ctxMap,s=this.myHtmlElements;e.clearRect(0,0,this.mapScreen.width,this.mapScreen.height),e.fillStyle=this.colors.grass,e.fillRect(0,0,this.mapScreen.width,this.mapScreen.height);const i=this.mapScreen.width/(this.map.getSize()/this.map.getBlockSize()),a=i/this.map.getBlockSize(),n=i+i/50;for(const s of this.map.terrain){const r=s.x*a,o=s.y*a;if(s.type===t.Water&&(e.fillStyle=this.colors.water,e.fillRect(r,o,n,n)),s.type!==t.Water){const t=n/2;e.save(),e.translate(r+t,o+t),e.rotate(s.angle*Math.PI/180),e.drawImage(this.waterTrianglePNG,-t,-t,i,i),e.restore()}}{const t=this.mapScreen.width/30,s=this.myPlayer.getCenterX()*a,i=this.myPlayer.getCenterY()*a;e.beginPath(),e.arc(s,i,t/2,0,2*Math.PI),e.fillStyle="red",e.fill()}{const t=this.snapshotManager.zone.innerCircle.getCenterX()*a,s=this.snapshotManager.zone.innerCircle.getCenterY()*a,i=this.snapshotManager.zone.innerCircle.getRadius()*a;e.beginPath(),e.arc(t,s,i,0,2*Math.PI),e.strokeStyle="green",e.stroke()}{const e=this.snapshotManager.zone.outerCircle.getCenterX()*a,t=this.snapshotManager.zone.outerCircle.getCenterY()*a,i=this.snapshotManager.zone.outerCircle.getRadius()*a;s.mapZoneCircle.setAttribute("r",i.toString()),s.mapZoneCircle.setAttribute("cx",e.toString()),s.mapZoneCircle.setAttribute("cy",t.toString())}}drawEditor(e){const s=this.ctxEditor;s.clearRect(0,0,this.editorScreen.width,this.editorScreen.height),s.fillStyle=this.colors.grass,s.fillRect(0,0,this.editorScreen.width,this.editorScreen.height),s.fillStyle=this.colors.water;for(const i of e.terrains)switch(i.type){case t.Water:s.fillRect(i.x,i.y,e.blockSize,e.blockSize);break;case t.WaterTriangle1:s.drawImage(this.waterTrianglePNG,i.x,i.y,e.blockSize,e.blockSize);break;case t.WaterTriangle2:case t.WaterTriangle3:case t.WaterTriangle4:let a=e.blockSize/2;s.save(),s.translate(i.x+a,i.y+a),s.rotate(i.angle*Math.PI/180),s.drawImage(this.waterTrianglePNG,-a,-a,e.blockSize,e.blockSize),s.restore()}let i,a;if(null!=e.getTerrainType()){i=Math.floor(e.getX()/e.blockSize)*e.blockSize,a=Math.floor(e.getY()/e.blockSize)*e.blockSize;let n=-1;switch(e.getTerrainType()){case t.Water:s.fillStyle=this.colors.water,s.fillRect(i,a,e.blockSize,e.blockSize);break;case t.Grass:s.fillStyle=this.colors.grass,s.fillRect(i,a,e.blockSize,e.blockSize);break;case t.WaterTriangle1:n=0;break;case t.WaterTriangle2:n=90;break;case t.WaterTriangle3:n=180;break;case t.WaterTriangle4:n=270}if(-1!==n){s.fillStyle=this.colors.grass,s.fillRect(i,a,e.blockSize,e.blockSize);let t=e.blockSize/2;s.save(),s.translate(i+t,a+t),s.rotate(n*Math.PI/180),s.drawImage(this.waterTrianglePNG,-t,-t,e.blockSize,e.blockSize),s.restore()}}s.fillStyle=this.colors.blockFrame;for(let t=0;t<e.getSize();t++)s.fillRect(t*e.blockSize,0,1,e.getSize()*e.blockSize);for(let t=0;t<e.getSize();t++)s.fillRect(0,t*e.blockSize,e.getSize()*e.blockSize,1);null!=e.getTerrainType()&&(s.fillStyle=this.colors.blockFrameActive,s.fillRect(i,a,e.blockSize,1),s.fillRect(i,a+e.blockSize,e.blockSize,1),s.fillRect(i,a,1,e.blockSize),s.fillRect(i+e.blockSize,a,1,e.blockSize)),s.save(),"delete"===e.getObjectType()&&(s.globalAlpha=.6);for(const t of e.rocks)s.drawImage(this.rockSVG,t.x,t.y,t.size,t.size);for(const t of e.walls){let e=this.horizontalWallSVG;t.width<t.height&&(e=this.verticalWallSVG),(t.width<t.height||t.width>t.height)&&s.drawImage(e,t.x,t.y,t.width,t.height),t.width===t.height&&(s.fillStyle="black",s.fillRect(t.x,t.y,t.width,t.height))}for(const t of e.bushes)s.drawImage(this.bushSVG,t.x,t.y,t.size,t.size);for(const t of e.trees)s.drawImage(this.treeSVG,t.x,t.y,t.size,t.size);if(s.restore(),"delete"===e.getObjectType()){let t;for(const s of e.rocks){const i=s;i.x<=e.getX()&&i.x+i.size>=e.getX()&&i.y<=e.getY()&&i.y+i.size>=e.getY()&&(t=i)}for(const s of e.walls){const i=s;i.x<=e.getX()&&i.x+i.width>=e.getX()&&i.y<=e.getY()&&i.y+i.height>=e.getY()&&(t=i)}for(const s of e.bushes){const i=s;i.x<=e.getX()&&i.x+i.size>=e.getX()&&i.y<=e.getY()&&i.y+i.size>=e.getY()&&(t=i)}for(const s of e.trees){const i=s;i.x<=e.getX()&&i.x+i.size>=e.getX()&&i.y<=e.getY()&&i.y+i.size>=e.getY()&&(t=i)}if(t instanceof o&&s.drawImage(this.rockSVG,t.x,t.y,t.size,t.size),t instanceof h&&s.drawImage(this.bushSVG,t.x,t.y,t.size,t.size),t instanceof r&&s.drawImage(this.treeSVG,t.x,t.y,t.size,t.size),t instanceof c){s.fillRect(t.x,t.y,t.width,t.height);let e=this.verticalWallSVG;t.width>t.height&&(e=this.horizontalWallSVG),s.drawImage(e,t.x,t.y,t.width,t.height)}}if(e.getObjectType()){let t;switch(e.getObjectType()){case"bush":t=e.bush.size,s.drawImage(this.bushSVG,e.getX()-t/2,e.getY()-t/2,t,t);break;case"rock":t=e.rock.size,s.drawImage(this.rockSVG,e.getX()-t/2,e.getY()-t/2,t,t);break;case"tree":t=e.tree.size,s.drawImage(this.treeSVG,e.getX()-t/2,e.getY()-t/2,t,t);break;case"rect":t=e.rock.size,s.fillStyle="black",s.fillRect(e.getX()-t/2,e.getY()-t/2,t,t);break;case"verticalWall":s.drawImage(this.verticalWallSVG,e.getX()-e.verticalWall.width/2,e.getY()-e.verticalWall.height/2,e.verticalWall.width,e.verticalWall.height);break;case"horizontalWall":s.drawImage(this.horizontalWallSVG,e.getX()-e.horizontalWall.width/2,e.getY()-e.horizontalWall.height/2,e.horizontalWall.width,e.horizontalWall.height)}}}frameRateAdjuster(){const e=Date.now(),t=e-this.lastdrawTime;return this.lastdrawTime=e,t/16.66666}isPlayerUnderRoundObject(e,t){const s=e.getCenterX()-t.getCenterX(),i=e.getCenterY()-t.getCenterY();return Math.sqrt(s*s+i*i)<e.radius+t.radius}drawGame(i){const a=this.snapshotManager.betweenSnapshot,n=this.snapshotManager.players;if(!a)return;-1!==a.i.spectate&&(i=a.i.spectate);for(const e of n)if(e.id===i){this.myPlayer=e;break}if(!this.myPlayer)return;this.scope.setScope(this.snapshotManager.betweenSnapshot.i.s),this.finalResolutionAdjustment=this.scope.getFinalResolutionAdjustment(this.resolutionAdjustment),this.drawMap();const r=this.ctxGame,o=this.myHtmlElements;r.clearRect(0,0,this.gameScreen.width,this.gameScreen.height),r.fillStyle=this.colors.water,r.fillRect(0,0,this.gameScreen.width,this.gameScreen.height),r.fillStyle=this.colors.grass;const h=300;for(const e of this.map.blocks){const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw({x:e.x,y:e.y,size:h});a&&r.fillRect(t,s,i,i)}r.fillStyle=this.colors.water;for(const e of this.map.terrain){const{x:s,y:i,width:a,height:n,isOnScreen:o}=this.howToDraw({x:e.x,y:e.y,size:e.size});if(o)if(e.type===t.Water)r.fillRect(s,i,a,n);else if(e.type===t.WaterTriangle1)r.drawImage(this.waterTrianglePNG,s,i,a,n);else if(e.type===t.WaterTriangle2||e.type===t.WaterTriangle3||e.type===t.WaterTriangle4){let t=a/2;r.save(),r.translate(s+t,i+t),r.rotate(e.angle*Math.PI/180),r.drawImage(this.waterTrianglePNG,-t,-t,a,n),r.restore()}}r.fillStyle=this.colors.waterCircle;const l=this.frameRateAdjuster();for(const e of this.snapshotManager.waterCircles){if(!e.isActive())continue;e.flow(l);const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw({x:e.getX(),y:e.getY(),size:e.getSize()});if(a){const a=i/2;r.save(),r.globalAlpha=e.getOpacity(),r.beginPath(),r.arc(t+a,s+a,a,0,2*Math.PI),r.fill(),r.restore()}}r.fillStyle=this.colors.blockFrame;const c=1*this.resolutionAdjustment;for(const e of this.map.blocks){if(0===e.y){const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw({x:e.x,y:e.y,size:h});a&&r.fillRect(t,s,i,c)}{const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw({x:e.x,y:e.y+h,size:h});a&&r.fillRect(t,s,i,c)}if(0===e.x){const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw({x:e.x,y:e.y,size:h});a&&r.fillRect(t,s,c,i)}{const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw({x:e.x+h,y:e.y,size:h});a&&r.fillRect(t,s,c,i)}}for(const e of this.map.rocks)if(e.isActive()){const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw(e);a&&(r.save(),r.globalAlpha=e.getOpacity(),r.drawImage(this.rockSVG,t,s,i,i),r.restore())}r.fillStyle="black";for(const e of this.map.rectangleObstacles)if(e.isActive()){const{x:t,y:s,width:i,height:a,isOnScreen:n}=this.howToDraw({x:e.x,y:e.y,width:e.width,height:e.height});if(n){let n=this.horizontalWallSVG;e.width<e.height&&(n=this.verticalWallSVG),r.save(),r.globalAlpha=e.getOpacity(),r.drawImage(n,t,s,i,a),r.restore()}}for(const e of n){if(e.alive())continue;const{x:t,y:s,width:i,height:a,isOnScreen:n}=this.howToDraw({x:e.getX(),y:e.getY(),size:e.size});n&&r.drawImage(this.deadPlayer,t,s,i,a)}for(const e of a.l){const{x:t,y:i,size:a,isOnScreen:n}=this.howToDraw(e);let o;switch(e.type){case s.Pistol:o=this.pistolLootSVG;break;case s.Machinegun:o=this.machinegunLootSVG;break;case s.Shotgun:o=this.shotgunLootSVG;break;case s.Rifle:o=this.rifleLootSVG;break;case s.Smoke:o=this.smokeLootSVG;break;case s.Granade:o=this.granadeLootSVG;break;case s.Hammer:o=this.hammerLootSVG;break;case s.RedAmmo:o=this.redAmmoLootSVG;break;case s.BlueAmmo:o=this.blueAmmoLootSVG;break;case s.GreenAmmo:o=this.greenAmmoLootSVG;break;case s.OrangeAmmo:o=this.orangeAmmoLootSVG;break;case s.Vest:o=this.vestLootSVG;break;case s.Medkit:o=this.medkitLootSVG;break;case s.Scope2:o=this.scope2LootSVG;break;case s.Scope4:o=this.scope4LootSVG;break;case s.Scope6:o=this.scope6LootSVG}r.drawImage(o,t,i,a,a)}for(const t of n){if(!t.alive())continue;const{x:s,y:i,size:a,isOnScreen:n}=this.howToDraw({x:t.getX(),y:t.getY(),size:t.size});if(n){const e=a/2;r.beginPath(),r.arc(s+e,i+e,e,0,2*Math.PI);let n=this.colors.player;t.getVest()&&(n=this.colors.vest),r.fillStyle=n,r.fill();let o=.92*e;r.beginPath(),r.arc(s+e,i+e,o,0,2*Math.PI),r.fillStyle=this.colors.player,r.fill()}const o=280;if(t.getWeapon()===e.Pistol){const e=t.getCenterX()-o/2,s=t.getCenterY()-o/2,{x:i,y:a,size:n,isOnScreen:h}=this.howToDraw({x:e,y:s,size:o});if(h){let e=n/2;r.save(),r.translate(i+e,a+e),r.rotate(t.getAngle()*Math.PI/180),r.drawImage(this.pistolSVG,-e,-e,n,n),r.restore()}}if(t.getWeapon()===e.Machinegun){const e=t.getCenterX()-o/2,s=t.getCenterY()-o/2,{x:i,y:a,size:n,isOnScreen:h}=this.howToDraw({x:e,y:s,size:o});if(h){let e=n/2;r.save(),r.translate(i+e,a+e),r.rotate(t.getAngle()*Math.PI/180),r.drawImage(this.machinegunSVG,-e,-e,n,n),r.restore()}}if(t.getWeapon()===e.Shotgun){const e=t.getCenterX()-o/2,s=t.getCenterY()-o/2,{x:i,y:a,size:n,isOnScreen:h}=this.howToDraw({x:e,y:s,size:o});if(h){let e=n/2;r.save(),r.translate(i+e,a+e),r.rotate(t.getAngle()*Math.PI/180),r.drawImage(this.shotgunSVG,-e,-e,n,n),r.restore()}}if(t.getWeapon()===e.Rifle){const e=t.getCenterX()-o/2,s=t.getCenterY()-o/2,{x:i,y:a,size:n,isOnScreen:h}=this.howToDraw({x:e,y:s,size:o});if(h){let e=n/2;r.save(),r.translate(i+e,a+e),r.rotate(t.getAngle()*Math.PI/180),r.drawImage(this.rifleSVG,-e,-e,n,n),r.restore()}}if(t.getWeapon()===e.Hammer){const e=t.getCenterX()-o/2,s=t.getCenterY()-o/2,{x:i,y:a,size:n,isOnScreen:h}=this.howToDraw({x:e,y:s,size:o});if(h){let e=n/2;r.save(),r.translate(i+e,a+e),r.rotate(t.getHammerAngle()*Math.PI/180),r.drawImage(this.hammerSVG,-e,-e,n,n),r.restore()}}if(t.getWeapon()===e.Hand||t.getWeapon()===e.Granade||t.getWeapon()===e.Smoke||t.getWeapon()===e.Medkit)for(let s=0;s<2;s++){const{x:i,y:a,size:n,isOnScreen:o}=this.howToDraw({x:t.hands[s].getX(),y:t.hands[s].getY(),size:t.hands[s].size});if(o){const o=n/2;r.beginPath(),r.arc(i+o,a+o,o,0,2*Math.PI),r.fillStyle=this.colors.handBorder,r.fill();const h=.8*o;if(r.beginPath(),r.arc(i+o,a+o,h,0,2*Math.PI),r.fillStyle=this.colors.hand,r.fill(),(t.getWeapon()===e.Granade||t.getWeapon()===e.Smoke||t.getWeapon()===e.Medkit)&&1===s){const i=t.getAngle(),a=1.2,n=t.hands[s].radius*a,o=Math.sin(i*Math.PI/180)*n,h=Math.cos(i*Math.PI/180)*n,{x:l,y:c,size:m,isOnScreen:g}=this.howToDraw({x:t.hands[s].getCenterX()+o-t.hands[s].radius*a,y:t.hands[s].getCenterY()-h-t.hands[s].radius*a,size:t.hands[s].size*a});if(g){const s=30;let a,n=m/2;r.save(),r.translate(l+n,c+n),r.rotate((i-s)*Math.PI/180),t.getWeapon()===e.Granade&&(a=this.granadeSVG),t.getWeapon()===e.Smoke&&(a=this.smokeSVG),t.getWeapon()===e.Medkit&&(a=this.medkitSVG),r.drawImage(a,-n,-n,m,m),r.restore()}}}}t.getWeapon()===e.Pistol&&(this.drawHandOnWeapon(t,27,0),this.drawHandOnWeapon(t,60,12)),t.getWeapon()===e.Machinegun&&(this.drawHandOnWeapon(t,27,0),this.drawHandOnWeapon(t,75,10)),t.getWeapon()===e.Shotgun&&(this.drawHandOnWeapon(t,27,0),this.drawHandOnWeapon(t,75,10)),t.getWeapon()===e.Rifle&&(this.drawHandOnWeapon(t,27,0),this.drawHandOnWeapon(t,80,9)),t.getWeapon()===e.Hammer&&(this.drawHandOnWeapon(t,40,30),this.drawHandOnWeapon(t,40,-30))}for(const e of this.snapshotManager.players){r.fillStyle=this.colors.collisionPoint;for(let t=e.bloods.length-1;t>=0;t--){const s=e.bloods[t];if(s.getTimer()<s.timerMax){s.shift();const t=e.getCenterX()+s.getX(),i=e.getCenterY()+s.getY(),{x:a,y:n,size:o,isOnScreen:h}=this.howToDraw({x:t,y:i,size:s.size});if(h){const e=1-s.getTimer()/s.timerMax;r.save(),r.globalAlpha=e,r.fillRect(a,n,o,o),r.restore()}}else e.bloods.splice(t,1)}}for(const e of a.g){const t=40*e.b,{x:s,y:i,size:a,isOnScreen:n}=this.howToDraw({x:e.x-t/2,y:e.y-t/2,size:t});if(n){let t=a/2;r.save(),r.translate(s+t,i+t),r.rotate(e.a*Math.PI/180),"g"===e.t&&r.drawImage(this.granadeSVG,-t,-t,a,a),"s"===e.t&&r.drawImage(this.smokeSVG,-t,-t,a,a),r.restore()}}this.createBulletLines();for(const e of this.bulletLines){let t=0;for(const s of e.parts){t++;let e=.05*t+.1;if(e>.8&&(e=.8),s.isActive()){let t=e-s.getAge()/14.3;t<0&&(t=0);const{x:i,y:a}=this.howToDraw({x:s.startX,y:s.startY,size:1}),{x:n,y:o}=this.howToDraw({x:s.endX,y:s.endY,size:1});Math.abs(i-n)>100||Math.abs(a-o)>100?(console.log("err: bullet lines"),console.log("partLine",s)):(r.save(),r.globalAlpha=t,r.beginPath(),r.moveTo(i,a),r.lineTo(n,o),r.lineWidth=(6-s.getAge()/3.33)*this.finalResolutionAdjustment,r.strokeStyle="white",r.stroke(),r.restore()),s.increaseAge()}}}for(const e of this.map.bushes)if(e.isActive()){const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw(e);if(a){let a=1;this.isPlayerUnderRoundObject(this.myPlayer,e)&&(a=.8);let n=i/2;r.save(),r.translate(t+n,s+n),r.rotate(e.angle*Math.PI/180),r.globalAlpha=e.getOpacity()*a,r.drawImage(this.bushSVG,-n,-n,i,i),r.restore()}}for(const e of this.map.trees)if(e.isActive()){const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw(e);if(a){let a=1;this.isPlayerUnderRoundObject(this.myPlayer,e)&&(a=.8);let n=i/2;r.save(),r.translate(t+n,s+n),r.rotate(e.angle*Math.PI/180),r.globalAlpha=e.getOpacity()*a,r.drawImage(this.treeSVG,-n,-n,i,i),r.restore()}}for(const e of a.s){const{x:t,y:s,size:i,isOnScreen:a}=this.howToDraw({x:e.x-e.s/2,y:e.y-e.s/2,size:e.s});a&&(r.save(),r.globalAlpha=e.o,r.drawImage(this.smokeCloudSVG,t,s,i,i),r.restore())}const{x:m,y:g,size:d}=this.howToDraw({x:this.snapshotManager.zone.outerCircle.getCenterX(),y:this.snapshotManager.zone.outerCircle.getCenterY(),size:this.snapshotManager.zone.outerCircle.getRadius()});o.zoneCircle.setAttribute("r",d.toString()),o.zoneCircle.setAttribute("cx",m.toString()),o.zoneCircle.setAttribute("cy",g.toString()),o.healthBar.in.style.width=a.i.h+"%";const p=Math.round(a.i.l/a.i.lE*100),y=Math.round((a.i.lE-a.i.l)/1e3*10)/10;if(y&&this.myPlayer.alive()){o.takeLoot.style.display="none",o.loading.main.style.visibility="visible",o.loading.text.style.display="block",o.loading.text.textContent=a.i.lT;let e=y.toString();switch(e){case"0":e=" 0.0";break;case"1":e=" 1.0";break;case"2":e=" 2.0";break;case"3":e=" 3.0";break;case"4":e=" 4.0";break;case"5":e=" 5.0"}o.loading.counter.textContent=e,o.loading.circle.setAttribute("stroke-dasharray",p+", 100")}else o.loading.main.style.visibility="hidden",o.loading.text.style.display="none",o.takeLoot.style.display="block",this.takeLootInfo();o.items.redAmmo.textContent=this.snapshotManager.betweenSnapshot.i.r.toString(),o.items.greenAmmo.textContent=this.snapshotManager.betweenSnapshot.i.g.toString(),o.items.blueAmmo.textContent=this.snapshotManager.betweenSnapshot.i.b.toString(),o.items.orangeAmmo.textContent=this.snapshotManager.betweenSnapshot.i.o.toString(),o.items.item1in.textContent=this.itemName(this.snapshotManager.betweenSnapshot.i.i1),o.items.item2in.textContent=this.itemName(this.snapshotManager.betweenSnapshot.i.i2),this.itemAmmoColor(1,this.snapshotManager.betweenSnapshot.i.i1),this.itemAmmoColor(2,this.snapshotManager.betweenSnapshot.i.i2),o.items.item3in.textContent=this.itemName(this.snapshotManager.betweenSnapshot.i.i3);let u=this.itemName(this.snapshotManager.betweenSnapshot.i.i4);const w=this.snapshotManager.betweenSnapshot.i.s4;u&&(u+=" "+w),o.items.item4in.textContent=u;let b=this.itemName(this.snapshotManager.betweenSnapshot.i.i5);const S=this.snapshotManager.betweenSnapshot.i.s5;b&&(b+=" "+S),o.items.item5in.textContent=b,this.activeItem(a.i.ai);let k="";if(this.myPlayer.getWeapon()===e.Pistol||this.myPlayer.getWeapon()===e.Rifle||this.myPlayer.getWeapon()===e.Machinegun||this.myPlayer.getWeapon()===e.Shotgun){let t=0;switch(this.myPlayer.getWeapon()){case e.Pistol:t=a.i.o;break;case e.Rifle:t=a.i.g;break;case e.Machinegun:t=a.i.b;break;case e.Shotgun:t=a.i.r}k=a.i.a.toString()+" / "+t}else this.myPlayer.getWeapon()===e.Hand||this.myPlayer.getWeapon()===e.Hammer?k="∞":this.myPlayer.getWeapon()===e.Granade||this.myPlayer.getWeapon()===e.Smoke?k=w.toString():this.myPlayer.getWeapon()===e.Medkit&&(k=S.toString());o.activeGunAmmo.textContent=k;let f=0;for(const e of this.snapshotManager.players)e.alive()&&f++;o.alive.textContent=f.toString();let M="none";if(1!==this.snapshotManager.betweenSnapshot.i.s)switch(M="block",this.snapshotManager.betweenSnapshot.i.s){case 2:o.items.scope2.style.display="block",o.items.scope4.style.display="none",o.items.scope6.style.display="none";break;case 4:o.items.scope2.style.display="none",o.items.scope4.style.display="block",o.items.scope6.style.display="none";break;case 6:o.items.scope2.style.display="none",o.items.scope4.style.display="none",o.items.scope6.style.display="block"}o.items.scope.style.display=M,M="none",this.snapshotManager.betweenSnapshot.i.v&&(M="block"),o.items.vest.style.display=M,this.snapshotManager.messageManager(),o.messages.innerHTML="";for(let e=this.snapshotManager.messages.length-1;e>=0;e--){const t=this.snapshotManager.messages[e],s=document.createElement("p");s.textContent=t.text,o.messages.appendChild(s)}if(this.snapshotManager.betweenSnapshot.z.hasOwnProperty("d")){let e="";this.snapshotManager.betweenSnapshot.z.d>0?e+=this.snapshotManager.betweenSnapshot.z.d:e="Zone is moving!",o.zoneTimer.innerText=e}o.spectate.style.display="none",a.i.spectateName&&(o.spectateName.innerText=a.i.spectateName,o.spectate.style.display="block")}drawHandOnWeapon(t,s,i){const a=this.ctxGame;let n=i+t.getAngle();t.getWeapon()===e.Hammer&&(n=i+t.getHammerAngle()),n>=360&&(n-=360);const r=Math.sin(n*Math.PI/180)*s,o=Math.cos(n*Math.PI/180)*s,h=t.getCenterX()+r-t.hands[0].radius,l=t.getCenterY()-o-t.hands[0].radius,{x:c,y:m,size:g,isOnScreen:d}=this.howToDraw({x:h,y:l,size:t.hands[0].size});if(d){const e=g/2;a.beginPath(),a.arc(c+e,m+e,e,0,2*Math.PI),a.fillStyle=this.colors.handBorder,a.fill();const t=.8*e;a.beginPath(),a.arc(c+e,m+e,t,0,2*Math.PI),a.fillStyle=this.colors.hand,a.fill()}}createBulletLines(){for(const e of this.snapshotManager.betweenSnapshot.b){let t=!1;for(const s of this.bulletLines)if(s.id===e.id){s.setEnd(e.x,e.y),t=!0;break}t||this.bulletLines.push(new d(e.id,e.x,e.y))}for(let e=this.bulletLines.length-1;e>=0;e--)this.bulletLines[e].isActive()||this.bulletLines.splice(e,1)}activeItem(e){const t=this.myHtmlElements;switch(t.items.item1.classList.remove("active"),t.items.item2.classList.remove("active"),t.items.item3.classList.remove("active"),t.items.item4.classList.remove("active"),t.items.item5.classList.remove("active"),e){case 1:t.items.item1.classList.add("active");break;case 2:t.items.item2.classList.add("active");break;case 3:t.items.item3.classList.add("active");break;case 4:t.items.item4.classList.add("active");break;case 5:t.items.item5.classList.add("active")}}itemAmmoColor(t,s){let i;1===t?i=this.myHtmlElements.items.item1Ammo:2===t&&(i=this.myHtmlElements.items.item2Ammo);let a="transparent";switch(s){case e.Pistol:a="orange";break;case e.Machinegun:a="blue";break;case e.Rifle:a="Green";break;case e.Shotgun:a="red"}i&&(i.style.background=a)}itemName(t){let s="";return t===e.Pistol&&(s="Pistol"),t===e.Rifle&&(s="Rifle"),t===e.Machinegun&&(s="Machinegun"),t===e.Shotgun&&(s="Shotgun"),t===e.Granade&&(s="Granade"),t===e.Smoke&&(s="Smoke"),t===e.Hand&&(s="Hands"),t===e.Hammer&&(s="Hammer"),t===e.Medkit&&(s="Medkit"),s}takeLootInfo(){const e=this.myHtmlElements;let t="";if(this.snapshotManager.betweenSnapshot&&this.myPlayer.alive()){for(const i of this.snapshotManager.betweenSnapshot.l){const a=this.myPlayer.getCenterX()-(i.x+i.size/2),n=this.myPlayer.getCenterY()-(i.y+i.size/2);if(Math.sqrt(a*a+n*n)<this.snapshotManager.players[0].radius+i.size/2){let a="";switch(i.type){case s.BlueAmmo:case s.RedAmmo:case s.GreenAmmo:case s.OrangeAmmo:a="Ammo";break;case s.Pistol:a="Pistol";break;case s.Rifle:a="Rifle";break;case s.Machinegun:a="Machinegun";break;case s.Shotgun:a="Shotgun";break;case s.Scope2:a="2X scope";break;case s.Scope4:a="4X scope";break;case s.Scope6:a="6X scope";break;case s.Granade:a="Granade";break;case s.Smoke:a="Smoke";break;case s.Medkit:a="Medkit";break;case s.Vest:a="Vest";break;case s.Hammer:a="Hammer"}let n="";return i.quantity&&(n+=i.quantity),t=a+" "+n+" (E)",void(e.takeLoot.innerText=t)}}e.takeLoot.innerText=t}else e.takeLoot.innerText=t}howToDraw(e){let t=0,s=0,i=0;e.size?(t=e.size*this.finalResolutionAdjustment,s=t,i=t):(s=e.width*this.finalResolutionAdjustment,i=e.height*this.finalResolutionAdjustment);const a=this.screenCenterX+(e.x-this.myPlayer.getCenterX())*this.finalResolutionAdjustment,n=this.screenCenterY+(e.y-this.myPlayer.getCenterY())*this.finalResolutionAdjustment;let r=!0;return(a>this.gameScreen.width||a<-s||n>this.gameScreen.height||n<-i)&&(r=!1),{x:a,y:n,size:t,width:s,height:i,isOnScreen:r}}gameOver(e,t,s){setTimeout((()=>{const i=this.myHtmlElements;t||s?(i.gameOverMenu.h1.textContent="Winner!",s&&(i.gameOverMenu.h1.textContent=s+" win"),i.gameOverMenu.spectate.style.display="none"):(i.gameOverMenu.h1.textContent="You died",i.gameOverMenu.spectate.style.display="block"),i.open(i.gameOverMenu.main),i.gameOverMenu.stats.innerHTML="";const a=document.createElement("p");a.textContent="Kills: "+e.kills.toString();const n=document.createElement("p");n.textContent="Damage dealt: "+e.damageDealt.toString();const r=document.createElement("p");r.textContent="Damage taken: "+e.damageTaken.toString();const o=document.createElement("p"),h=Math.floor(e.survive/60),l=h+"m "+(e.survive-60*h)+"s";o.textContent="Survive: "+l,i.gameOverMenu.stats.appendChild(a),i.gameOverMenu.stats.appendChild(n),i.gameOverMenu.stats.appendChild(r),t||i.gameOverMenu.stats.appendChild(o)}),2e3)}}class w{constructor(e){this.blocks=[],this.terrain=[],this.impassableRoundObstacles=[],this.bushes=[],this.trees=[],this.rocks=[],this.rectangleObstacles=[],this.waterTerrainData=e}reset(){this.blocks.splice(0,this.blocks.length),this.terrain.splice(0,this.terrain.length),this.impassableRoundObstacles.splice(0,this.impassableRoundObstacles.length),this.bushes.splice(0,this.bushes.length),this.trees.splice(0,this.trees.length),this.rocks.splice(0,this.rocks.length),this.rectangleObstacles.splice(0,this.rectangleObstacles.length)}getSize(){return this.size}getBlockSize(){return this.blockSize}openMap(e){this.size=e.size*e.blockSize,this.blockSize=e.blockSize;for(let t=0;t<e.size;t++)for(let s=0;s<e.size;s++)this.blocks.push({x:s*e.blockSize,y:t*e.blockSize});for(const t of e.terrains)this.terrain.push(new a(t.type,t.x,t.y,t.size));let t=0;for(const s of e.rocks){const e=new o(t++,s.x,s.y);this.rocks.push(e),this.impassableRoundObstacles.push(e)}for(const s of e.bushes)this.bushes.push(new h(t++,s.x,s.y,s.angle));for(const s of e.trees){const e=new r(t++,s.x,s.y,s.angle);this.trees.push(e),this.impassableRoundObstacles.push(e)}for(const s of e.rects)this.rectangleObstacles.push(new c(t++,s.x,s.y,s.width,s.height))}}class b{constructor(){this.waterTriangle1=[],this.waterTriangle2=[],this.waterTriangle3=[],this.waterTriangle4=[]}setData(e,s){switch(e){case t.WaterTriangle1:this.waterTriangle1=s;break;case t.WaterTriangle2:this.waterTriangle2=s;break;case t.WaterTriangle3:this.waterTriangle3=s;break;case t.WaterTriangle4:this.waterTriangle4=s;break;default:throw new Error("Unknown water type")}}includeWater(e,s,i){let a,n=!1;switch(e){case t.WaterTriangle1:a=this.waterTriangle1;break;case t.WaterTriangle2:a=this.waterTriangle2;break;case t.WaterTriangle3:a=this.waterTriangle3;break;case t.WaterTriangle4:a=this.waterTriangle4;break;default:throw new Error("Unknown water type")}if(s<a.length&&i<a[s].length)a[s][i]&&(n=!0);else{if(0!==a.length)throw new Error("Out of range on water type");n=!0}return n}}class S{constructor(){this.body=[],this.hand=[],this.hammer=[],this.ready=!1}setData(e,t,s){this.body=e,this.hand=t,this.hammer=s,this.ready=!0}isReady(){return this.ready}}class k{constructor(e,t,s){this.x=e,this.y=t,this.size=s,this.radius=s/2}setX(e){this.x=e}setY(e){this.y=e}getX(){return this.x}getY(){return this.y}getCenterX(){return this.x+this.radius}getCenterY(){return this.y+this.radius}}class f{constructor(){this.size=8,this.timer=0,this.timerMax=60,this.x=-1*Math.round(30*Math.random()),this.y=Math.round(30*Math.random())}shift(){this.x+=.7,this.y-=.7,this.timer++}getX(){return this.x}getY(){return this.y}getTimer(){return this.timer}}class M{constructor(e){this.live=!0,this.hands=[],this.bloods=[],this.vest=!1,this.id=e.i,this.x=e.x,this.y=e.y,this.angle=e.a,this.hammerAngle=e.m,this.weapon=e.w,this.size=e.size,this.radius=this.size/2,this.hands.push(new k(e.lX,e.lY,e.hSize)),this.hands.push(new k(e.rX,e.rY,e.hSize))}createInjury(e){for(let t=0;t<e/2;t++)this.bloods.push(new f)}getVest(){return this.vest}setVest(e){this.vest=e}die(){this.live=!1}alive(){return this.live}setX(e){this.x=e}setY(e){this.y=e}setAngle(e){this.angle=e}setHammerAngle(e){this.hammerAngle=e}setWeapon(e){this.weapon=e}getX(){return this.x}getY(){return this.y}getAngle(){return this.angle}getHammerAngle(){return this.hammerAngle}getWeapon(){return this.weapon}getCenterX(){return this.x+this.radius}getCenterY(){return this.y+this.radius}}class v{constructor(e,t,s){this.centerX=e,this.centerY=t,this.radius=s}setCenterX(e){this.centerX=e}setCenterY(e){this.centerY=e}setRadius(e){this.radius=e}getCenterX(){return this.centerX}getCenterY(){return this.centerY}getRadius(){return this.radius}}class D{constructor(){this.innerCircle=new v(0,0,0),this.outerCircle=new v(0,0,0)}}class I{constructor(e,t){this.time=e,this.text=t}}class z{constructor(e){this.size=30,this.opacity=1,this.centerX=e.x,this.centerY=e.y}getX(){return this.centerX-this.size/2}getY(){return this.centerY-this.size/2}getSize(){return this.size}getOpacity(){return this.opacity}flow(e=1){this.size+=2*e,this.opacity-=.02*e}isActive(){return this.opacity>.04}}class E{constructor(e,t){this.snapshots=[],this.messages=[],this.players=[],this.waterCircles=[],this.newerExists=!1,this.olderExists=!1,this.sumaNewer=0,this.averageSumaNewer=[],this.serverClientSync=e,this.zone=new D,this.map=t}addSumaNewer(e){if(this.averageSumaNewer.push(e),this.averageSumaNewer.length>100){this.averageSumaNewer.splice(0,1);let e=0;for(const t of this.averageSumaNewer)e+=t;console.log("averageSumaNewer: ",e/100)}}reset(){this.snapshots.splice(0,this.snapshots.length),this.players.splice(0,this.players.length),this.betweenSnapshot=null,this.beforeSnapshotForTestBullets=null}messageManager(){for(let e=this.messages.length-1;e>=0;e--)this.messages[e].time+5e3<Date.now()&&this.messages.splice(e,1);if(this.messages.length>5){const e=this.messages.length-5;this.messages.splice(0,e)}}addSnapshot(e){let t=this.serverClientSync.getDrawDelay()-(this.serverClientSync.getServerTime()-e.t);if(t<0&&(t=0),e.w)for(const s of e.w)setTimeout((()=>{this.waterCircles.push(new z(s))}),t);for(let e=this.waterCircles.length-1;e>=0;e--)this.waterCircles[e].isActive()||this.waterCircles.splice(e,1);if(e.p)for(const s of e.p)s.d&&setTimeout((()=>{for(const e of this.players)if(e.id===s.i){e.createInjury(s.d);break}}),t),s.hasOwnProperty("v")&&setTimeout((()=>{for(const e of this.players)if(e.id===s.i){let t=!1;1===s.v&&(t=!0),e.setVest(t);break}}),t);if(this.snapshots.push(e),this.snapshots.length>1&&this.completeSnapshot(this.snapshots[this.snapshots.length-2],e),e.m)for(const s of e.m)setTimeout((()=>{this.messages.push(new I(Date.now(),s))}),t);this.updateMap(e,t),this.snapshots.length>50&&this.snapshots.splice(0,1)}updateMap(e,t){const s=e.o;for(const e of s)switch(e.t){case"w":for(const s of this.map.rectangleObstacles)if(s.id===e.i){setTimeout((()=>{s.update(e.o)}),t);break}break;case"r":for(const s of this.map.rocks)if(s.id===e.i){setTimeout((()=>{s.update(e.o)}),t);break}break;case"t":for(const s of this.map.trees)if(s.id===e.i){setTimeout((()=>{s.update(e.o)}),t);break}break;case"b":for(const s of this.map.bushes)if(s.id===e.i){setTimeout((()=>{s.update(e.o)}),t);break}}}updateZone(){if(!this.betweenSnapshot)return;const e=this.betweenSnapshot.z;this.zone.innerCircle.setRadius(e.iR),this.zone.innerCircle.setCenterX(e.iX),this.zone.innerCircle.setCenterY(e.iY),this.zone.outerCircle.setRadius(e.oR),this.zone.outerCircle.setCenterX(e.oX),this.zone.outerCircle.setCenterY(e.oY)}completeSnapshot(e,t){this.completePlayerSnapshots(e.p,t.p),this.completeMyPlayerSnapshot(e.i,t.i),this.completeLootSnapshots(e.l,t.l),this.completeZoneSnapshot(e.z,t.z),t.z.hasOwnProperty("d")||(t.z.d=e.z.d)}completeMyPlayerSnapshot(e,t){t.hasOwnProperty("h")||(t.h=e.h),t.hasOwnProperty("i1")||(t.i1=e.i1),t.hasOwnProperty("i2")||(t.i2=e.i2),t.hasOwnProperty("i3")||(t.i3=e.i3),t.hasOwnProperty("i4")||(t.i4=e.i4),t.hasOwnProperty("i5")||(t.i5=e.i5),t.hasOwnProperty("s4")||(t.s4=e.s4),t.hasOwnProperty("s5")||(t.s5=e.s5),t.hasOwnProperty("a")||(t.a=e.a),t.hasOwnProperty("aM")||(t.aM=e.aM),t.hasOwnProperty("r")||(t.r=e.r),t.hasOwnProperty("g")||(t.g=e.g),t.hasOwnProperty("b")||(t.b=e.b),t.hasOwnProperty("o")||(t.o=e.o),t.hasOwnProperty("s")||(t.s=e.s),t.hasOwnProperty("v")||(t.v=e.v),t.hasOwnProperty("l")||(t.l=e.l),t.hasOwnProperty("lE")||(t.lE=e.lE),t.hasOwnProperty("lT")||(t.lT=e.lT),t.hasOwnProperty("spectate")||(t.spectate=e.spectate),t.hasOwnProperty("spectateName")||(t.spectateName=e.spectateName),t.hasOwnProperty("ai")||(t.ai=e.ai)}completeZoneSnapshot(e,t){t.hasOwnProperty("iX")||(t.iX=e.iX),t.hasOwnProperty("iY")||(t.iY=e.iY),t.hasOwnProperty("iR")||(t.iR=e.iR),t.hasOwnProperty("oX")||(t.oX=e.oX),t.hasOwnProperty("oY")||(t.oY=e.oY),t.hasOwnProperty("oR")||(t.oR=e.oR)}completeLootSnapshots(e,t){for(const s of t){let t;for(const i of e)i.i===s.i&&(t=i);t&&(s.hasOwnProperty("size")||(s.size=t.size),s.hasOwnProperty("type")||(s.type=t.type),s.hasOwnProperty("x")||(s.x=t.x),s.hasOwnProperty("y")||(s.y=t.y),!s.hasOwnProperty("quantity")&&t.hasOwnProperty("quantity")&&(s.quantity=t.quantity))}const s=[];for(const i of e){let e=!1;for(const s of t)if(i.i===s.i){e=!0;break}e||s.push(i)}for(const e of s)t.push(e);for(let e=t.length-1;e>=0;e--)t[e].hasOwnProperty("del")&&t.splice(e,1)}completePlayerSnapshots(e,t){for(const s of t){let t;for(const i of e)i.i===s.i&&(t=i);t&&(s.hasOwnProperty("a")||(s.a=t.a),s.hasOwnProperty("m")||(s.m=t.m),s.hasOwnProperty("size")||(s.size=t.size),s.hasOwnProperty("w")||(s.w=t.w),s.hasOwnProperty("x")||(s.x=t.x),s.hasOwnProperty("y")||(s.y=t.y),s.hasOwnProperty("l")||(s.l=t.l),s.hasOwnProperty("hSize")||(s.hSize=t.hSize),s.hasOwnProperty("lX")||(s.lX=t.lX),s.hasOwnProperty("lY")||(s.lY=t.lY),s.hasOwnProperty("rX")||(s.rX=t.rX),s.hasOwnProperty("rY")||(s.rY=t.rY))}const s=[];for(const i of e){let e=!1;for(const s of t)if(i.i===s.i){e=!0;break}e||s.push(i.i)}for(const i of s)for(const s of e)if(i===s.i){t.push(s);break}t.sort(((e,t)=>e.i-t.i))}createBetweenSnapshot(){if(this.snapshots.length&&this.serverClientSync.ready()){let e,t,s=0;this.sumaNewer=0,this.newerExists=!1,this.olderExists=!1;const i=this.serverClientSync.getServerTime()-this.serverClientSync.getDrawDelay();for(const e of this.snapshots)e.t<=i&&(t=e,this.olderExists=!0);for(const t of this.snapshots)t.t>=i&&(e||(e=t,this.newerExists=!0),this.sumaNewer++);if(e||(e=t),this.serverClientSync.changeSumaNewer(this.sumaNewer),t&&e){const a=e.t-t.t,n=i-t.t;a&&(s=n/a);const r=e;this.betweenSnapshot={t:r.t,i:Object.assign({},r.i),p:[],b:[],g:[],s:[],z:Object.assign({},r.z),l:[],o:[]};for(const e of r.p)this.betweenSnapshot.p.push(Object.assign({},e));for(const e of r.b)this.betweenSnapshot.b.push(Object.assign({},e));for(const e of r.g)this.betweenSnapshot.g.push(Object.assign({},e));for(const e of r.s)this.betweenSnapshot.s.push(Object.assign({},e));for(const e of r.l)this.betweenSnapshot.l.push(Object.assign({},e));for(let i=0;i<this.betweenSnapshot.p.length;i++){const a=this.betweenSnapshot.p[i];a.x=this.positionBetweenSnapshots(t.p[i].x,e.p[i].x,s),a.y=this.positionBetweenSnapshots(t.p[i].y,e.p[i].y,s),a.h||(a.lX=this.positionBetweenSnapshots(t.p[i].lX,e.p[i].lX,s),a.lY=this.positionBetweenSnapshots(t.p[i].lY,e.p[i].lY,s),a.rX=this.positionBetweenSnapshots(t.p[i].rX,e.p[i].rX,s),a.rY=this.positionBetweenSnapshots(t.p[i].rY,e.p[i].rY,s))}for(const i of this.betweenSnapshot.l){let a,n;for(const e of t.l)if(i.i===e.i){a=e;break}for(const t of e.l)if(i.i===t.i){n=t;break}a&&n&&(i.x=this.positionBetweenSnapshots(a.x,n.x,s),i.y=this.positionBetweenSnapshots(a.y,n.y,s))}this.betweenSnapshot.z.oR=this.positionBetweenSnapshots(t.z.oR,e.z.oR,s),this.betweenSnapshot.z.oX=this.positionBetweenSnapshots(t.z.oX,e.z.oX,s),this.betweenSnapshot.z.oY=this.positionBetweenSnapshots(t.z.oY,e.z.oY,s)}}this.updatePlayers(),this.updateZone()}updatePlayers(){if(this.betweenSnapshot)for(const e of this.betweenSnapshot.p){let t=!1;for(const s of this.players)if(s.id===e.i){s.setX(e.x),s.setY(e.y),s.setAngle(e.a),s.setWeapon(e.w),s.setHammerAngle(e.m),0===e.l&&s.die(),s.hands[0].setX(e.lX),s.hands[0].setY(e.lY),s.hands[1].setX(e.rX),s.hands[1].setY(e.rY),t=!0;break}t||this.players.push(new M(e))}}positionBetweenSnapshots(e,t,s){let i=1;return t<e&&(i=-1),e+Math.abs(t-e)*i*s}}class x{constructor(e,t,s,i,a){this.spectate=!1,this.gameRun=!1,this.gameId=-1,this.playerId=-1,this.socket=t,this.serverClientSync=s,this.waterTerrainData=new b,this.map=new w(this.waterTerrainData),this.snapshotManager=new E(s,this.map),this.mouse=e,this.myHtmlElements=i,this.editor=a,this.collisionPoints=new S,this.view=new u(this.map,this.mouse,this.waterTerrainData,this.myHtmlElements,this.collisionPoints,this.snapshotManager),setTimeout((()=>{this.loop()}),200)}reset(){const e=this.myHtmlElements;e.close(e.gameOverMenu.main),e.open(e.mainMenu.main,e.hideGame),e.gameOverMenu.stats.innerHTML="",this.gameRun=!1,this.gameId=-1,this.playerId=-1,this.map.reset(),this.snapshotManager.reset(),this.view.reset(),this.spectate=!1,this.serverClientSync.reset()}stop(){this.gameRun=!1}isNameOk(e){let t=!1;if("string"==typeof e&&e.length>0&&e.length<=20){let s=!1;for(let t=0;t<e.length;t++)if(-1==="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ".lastIndexOf(e[t])){s=!0;break}s||(t=!0)}return t}startSpectate(){this.spectate=!0}getSpectate(){return this.spectate}setName(e){this.name=e}getName(){return this.name}getGameId(){return this.gameId}setGameId(e){this.gameId=e}getPlayerId(){return this.playerId}setPlayerId(e){this.playerId=e}gameStart(){this.gameRun=!0,this.snapshotManager.reset()}gameActive(){return this.gameRun}loop(){requestAnimationFrame((()=>{this.loop()})),this.editor.isActive()&&this.view.drawEditor(this.editor),this.serverClientSync.ready()||Math.random()>.8&&this.socket.emit("serverClientSync",Date.now()),this.gameRun&&(this.snapshotManager.createBetweenSnapshot(),this.view.drawGame(this.playerId))}}class G{constructor(){this.ping=0,this.pings=[],this.timeDiference=0,this.timeDiferences=[],this.pingAttempts=5,this.defaultDrawDelay=70,this.drawDelay=this.defaultDrawDelay,this.minWantedSumaNewerSnapshots=3,this.defaultWantedNewerSnapshots=5,this.wantedSumaNewerSnapshots=this.defaultWantedNewerSnapshots,this.maxWantedSumaNewerSnapshots=11,this.lags=0,this.maxLags=10,this.lastLagTime=0}getPing(){return this.ping}getTimeDiference(){return this.timeDiference}changeSumaNewer(e){switch(0===e&&(this.lags++,this.lastLagTime=Date.now()),this.lags===this.maxLags&&this.wantedSumaNewerSnapshots<this.maxWantedSumaNewerSnapshots&&(this.wantedSumaNewerSnapshots++,this.lags=0),this.lastLagTime&&this.lastLagTime+5e3<Date.now()&&this.wantedSumaNewerSnapshots>this.minWantedSumaNewerSnapshots&&(this.wantedSumaNewerSnapshots--,this.lags=0,this.lastLagTime=Date.now()),this.wantedSumaNewerSnapshots){case 3:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(.5),2===e&&this.changeDrawDelay(.2),4===e&&this.changeDrawDelay(-.2),5===e&&this.changeDrawDelay(-.5),6===e&&this.changeDrawDelay(-2),7===e&&this.changeDrawDelay(-2),8===e&&this.changeDrawDelay(-5),e>8&&this.changeDrawDelay(-10);break;case 4:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(2),2===e&&this.changeDrawDelay(.5),3===e&&this.changeDrawDelay(.2),5===e&&this.changeDrawDelay(-.2),6===e&&this.changeDrawDelay(-.5),7===e&&this.changeDrawDelay(-2),8===e&&this.changeDrawDelay(-2),9===e&&this.changeDrawDelay(-5),e>9&&this.changeDrawDelay(-10);break;case 5:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(2),2===e&&this.changeDrawDelay(1),3===e&&this.changeDrawDelay(.5),4===e&&this.changeDrawDelay(.2),6===e&&this.changeDrawDelay(-.2),7===e&&this.changeDrawDelay(-.5),8===e&&this.changeDrawDelay(-2),9===e&&this.changeDrawDelay(-2),10===e&&this.changeDrawDelay(-5),e>10&&this.changeDrawDelay(-10);break;case 6:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(2),2===e&&this.changeDrawDelay(1),3===e&&this.changeDrawDelay(.5),4===e&&this.changeDrawDelay(.5),5===e&&this.changeDrawDelay(.2),7===e&&this.changeDrawDelay(-.2),8===e&&this.changeDrawDelay(-.5),9===e&&this.changeDrawDelay(-2),10===e&&this.changeDrawDelay(-2),11===e&&this.changeDrawDelay(-5),e>11&&this.changeDrawDelay(-10);break;case 7:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(2),2===e&&this.changeDrawDelay(1),3===e&&this.changeDrawDelay(.5),4===e&&this.changeDrawDelay(.5),5===e&&this.changeDrawDelay(.2),6===e&&this.changeDrawDelay(.2),8===e&&this.changeDrawDelay(-.2),9===e&&this.changeDrawDelay(-.5),10===e&&this.changeDrawDelay(-2),11===e&&this.changeDrawDelay(-2),12===e&&this.changeDrawDelay(-5),e>12&&this.changeDrawDelay(-10);break;case 8:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(2),2===e&&this.changeDrawDelay(1),3===e&&this.changeDrawDelay(1),4===e&&this.changeDrawDelay(.5),5===e&&this.changeDrawDelay(.5),6===e&&this.changeDrawDelay(.2),7===e&&this.changeDrawDelay(.2),9===e&&this.changeDrawDelay(-.2),10===e&&this.changeDrawDelay(-.5),11===e&&this.changeDrawDelay(-2),12===e&&this.changeDrawDelay(-2),13===e&&this.changeDrawDelay(-5),e>13&&this.changeDrawDelay(-10);break;case 9:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(2),2===e&&this.changeDrawDelay(2),3===e&&this.changeDrawDelay(1),4===e&&this.changeDrawDelay(1),5===e&&this.changeDrawDelay(.5),6===e&&this.changeDrawDelay(.5),7===e&&this.changeDrawDelay(.2),8===e&&this.changeDrawDelay(.2),10===e&&this.changeDrawDelay(-.2),11===e&&this.changeDrawDelay(-.5),12===e&&this.changeDrawDelay(-2),13===e&&this.changeDrawDelay(-2),14===e&&this.changeDrawDelay(-5),e>14&&this.changeDrawDelay(-10);break;case 10:0===e&&this.changeDrawDelay(5),1===e&&this.changeDrawDelay(5),2===e&&this.changeDrawDelay(2),3===e&&this.changeDrawDelay(2),4===e&&this.changeDrawDelay(1),5===e&&this.changeDrawDelay(1),6===e&&this.changeDrawDelay(.5),7===e&&this.changeDrawDelay(.5),8===e&&this.changeDrawDelay(.2),9===e&&this.changeDrawDelay(.2),11===e&&this.changeDrawDelay(-.2),12===e&&this.changeDrawDelay(-.5),13===e&&this.changeDrawDelay(-2),14===e&&this.changeDrawDelay(-2),15===e&&this.changeDrawDelay(-5),e>5&&this.changeDrawDelay(-10);break;case 11:0===e&&this.changeDrawDelay(10),1===e&&this.changeDrawDelay(5),2===e&&this.changeDrawDelay(2),3===e&&this.changeDrawDelay(2),4===e&&this.changeDrawDelay(2),5===e&&this.changeDrawDelay(1),6===e&&this.changeDrawDelay(1),7===e&&this.changeDrawDelay(.5),8===e&&this.changeDrawDelay(.5),9===e&&this.changeDrawDelay(.2),10===e&&this.changeDrawDelay(.2),12===e&&this.changeDrawDelay(-.2),13===e&&this.changeDrawDelay(-.5),14===e&&this.changeDrawDelay(-2),15===e&&this.changeDrawDelay(-2),16===e&&this.changeDrawDelay(-5),e>16&&this.changeDrawDelay(-10)}}ready(){return this.pings.length===this.pingAttempts}reset(){this.pings=[],this.timeDiferences=[],this.ping=0,this.timeDiference=0,this.drawDelay=this.defaultDrawDelay,this.wantedSumaNewerSnapshots=this.defaultWantedNewerSnapshots,this.lags=0,this.lastLagTime=0}addData(e,t){if(this.ready()||(this.pings.push(e),this.timeDiferences.push(t)),this.pings.length===this.pingAttempts){let e=0;for(const t of this.pings)e+=t;this.ping=e/this.pingAttempts;let t=0;for(const e of this.timeDiferences)t+=e;this.timeDiference=t/this.pingAttempts}}changeDrawDelay(e){this.drawDelay+=e}getDrawDelay(){return this.drawDelay}getServerTime(){let e=Date.now();return this.ready()&&(e+=this.getTimeDiference()),e}}class T{constructor(){this.healthBar={main:document.getElementById("healthBar"),in:document.getElementById("healthBarIn")},this.items={redAmmo:document.getElementById("redAmmo"),greenAmmo:document.getElementById("greenAmmo"),blueAmmo:document.getElementById("blueAmmo"),orangeAmmo:document.getElementById("orangeAmmo"),item1:document.getElementById("item1"),item2:document.getElementById("item2"),item3:document.getElementById("item3"),item4:document.getElementById("item4"),item5:document.getElementById("item5"),item1in:document.getElementById("item1").getElementsByTagName("span")[0],item2in:document.getElementById("item2").getElementsByTagName("span")[0],item3in:document.getElementById("item3").getElementsByTagName("span")[0],item4in:document.getElementById("item4").getElementsByTagName("span")[0],item5in:document.getElementById("item5").getElementsByTagName("span")[0],item1Ammo:document.getElementById("item1Ammo"),item2Ammo:document.getElementById("item2Ammo"),scope:document.getElementById("scope"),scope2:document.getElementById("scope2"),scope4:document.getElementById("scope4"),scope6:document.getElementById("scope6"),scopeSVG:document.getElementById("scope").getElementsByTagName("img")[0],vest:document.getElementById("vest")},this.editor={coordinates:document.getElementById("editorCoordinates"),container:document.getElementById("editorContainer"),screen:document.getElementById("editorScreen"),terrainImgs:document.getElementById("editorTerrainImgs"),terrainWater:document.getElementById("terrainWater"),terrainGrass:document.getElementById("terrainGrass"),terrainWaterTriangle1:document.getElementById("terrainWaterTriangle1"),terrainWaterTriangle2:document.getElementById("terrainWaterTriangle2"),terrainWaterTriangle3:document.getElementById("terrainWaterTriangle3"),terrainWaterTriangle4:document.getElementById("terrainWaterTriangle4"),objectImgs:document.getElementById("editorObjectImgs"),objectBush:document.getElementById("editorObjectBush"),objectRock:document.getElementById("editorObjectRock"),objectTree:document.getElementById("editorObjectTree"),objectRect:document.getElementById("editorObjectRect"),objectHorizontalWall:document.getElementById("editorObjectHorizontalWall"),objectVerticalWall:document.getElementById("editorObjectVerticalWall"),objectDelete:document.getElementById("editorObjectDelete"),openMenu:document.getElementById("editorOpenMenu")},this.saveMapMenu={main:document.getElementById("saveMapMenu"),back:document.getElementById("saveMapMenuBack")},this.gameOverMenu={main:document.getElementById("gameOverMenu"),back:document.getElementById("gameOverMenuBack"),h1:document.getElementById("gameOverMenuH1"),stats:document.getElementById("gameOverMenuStats"),spectate:document.getElementById("gameOverMenuspectate")},this.mapEditorMenu={main:document.getElementById("mapEditorMenu"),name:document.getElementById("mapEditorMenuName"),save:document.getElementById("mapEditorMenuSave"),changeSize:document.getElementById("mapEditorMenuChangeSize"),back:document.getElementById("mapEditorMenuBack"),close:document.getElementById("mapEditorMenuClose")},this.alertMenu={main:document.getElementById("alertMenu"),ok:document.getElementById("alertMenuOk")},this.openMapMenu={main:document.getElementById("openMapMenu"),maps:document.getElementById("openMapMenuMaps"),ok:document.getElementById("openMapMenuOk"),back:document.getElementById("openMapMenuBack")},this.controlsMenu={main:document.getElementById("controlsMenu"),back:document.getElementById("controlsMenuBack")},this.mainMenu={main:document.getElementById("mainMenu"),ip:document.getElementById("mainMenuIp"),name:document.getElementById("mainMenuName"),games:document.getElementById("mainMenuGames"),join:document.getElementById("mainMenuJoin"),maps:document.getElementById("mainMenuMaps"),create:document.getElementById("mainMenuCreate"),openEditor:document.getElementById("mainMenuOpenEditor"),controls:document.getElementById("mainMenuControls")},this.gameCanceledMenu={main:document.getElementById("cancelLobbyMenu"),back:document.getElementById("cancelLobbyMenuBack")},this.mapSizeMenu={main:document.getElementById("mapSizeMenu"),value:document.getElementById("mapSizeValue"),ok:document.getElementById("mapSizeOk"),back:document.getElementById("mapSizeBack")},this.mapMenu={main:document.getElementById("mapMenu"),create:document.getElementById("mapMenuCreate"),open:document.getElementById("mapMenuOpenMap"),back:document.getElementById("mapMenuBack")},this.lobbyMenu={main:document.getElementById("lobbyMenu"),gameName:document.getElementById("lobbyMenuGameName"),players:document.getElementById("lobbyMenuPlayers"),forJoinPlayers:document.getElementById("lobbyMenuForJoinPlayer"),leave:document.getElementById("lobbyMenuLeave"),forCreatePlayer:document.getElementById("lobbyMenuForCreatePlayer"),start:document.getElementById("lobbyMenuStart"),cancel:document.getElementById("lobbyMenuCancel")},this.loading={main:document.getElementById("loading"),counter:document.getElementById("loadingCounter"),circle:document.getElementById("loadingCircle"),text:document.getElementById("loadingText")},this.escFromGameMenu={main:document.getElementById("escFromGame"),back:document.getElementById("escFromGameBack"),leave:document.getElementById("escFromGameLeave")},this.gameScreen=document.getElementById("gameScreen"),this.mapScreen=document.getElementById("mapScreen"),this.helperScreen=document.getElementById("helperScreen"),this.zoneSVG=document.getElementById("zoneSVG"),this.zoneCircle=document.getElementById("zoneCircle"),this.zoneRect=document.getElementById("zoneRect"),this.mapZoneSVG=document.getElementById("mapZoneSVG"),this.mapZoneCircle=document.getElementById("mapZoneCircle"),this.takeLoot=document.getElementById("takeLoot"),this.transparentLayer=document.getElementById("transparentLayer"),this.activeGunAmmo=document.getElementById("activeGunAmmo"),this.mapContainer=document.getElementById("mapContainer"),this.alive=document.getElementById("alive"),this.messages=document.getElementById("messages"),this.zoneTimer=document.getElementById("zoneTimer"),this.spectate=document.getElementById("spectate"),this.spectateName=document.getElementById("spectateName"),this.hideGame=document.getElementById("hideGame"),this.itNetwork=document.getElementById("itnetwork")}close(...e){for(const t of e)t.style.display="none"}open(...e){for(const t of e)t.style.display="block"}}class C{constructor(e,t,s,i,a,n,r){this.size=e,this.blockSize=t,this.terrains=s,this.rects=i,this.bushes=a,this.rocks=n,this.trees=r}}class P{constructor(e,t){this.active=!1,this.blockSize=300,this.terrains=[],this.bushes=[],this.rocks=[],this.trees=[],this.walls=[],this.myHtmlElements=e,this.socket=t,this.colors=new m,this.bush=new h(0,0,0,0),this.rock=new o(0,0,0),this.tree=new r(0,0,0,0),this.horizontalWall=new c(0,0,0,306,72.5),this.verticalWall=new c(0,0,0,72.5,306),this.controller()}isActive(){return this.active}close(){this.active=!1}getTerrainType(){return this.terrainType}getObjectType(){return this.objectType}getSize(){return this.size}getX(){return this.x}getY(){return this.y}getMapData(){return new C(this.size,this.blockSize,this.terrains,this.walls,this.bushes,this.rocks,this.trees)}create(){this.cleanMap()}changeSize(e){this.active=!0;const t=this.myHtmlElements;this.size=e,t.editor.screen.width=e*this.blockSize,t.editor.screen.height=e*this.blockSize;const s=(e*this.blockSize).toString();t.editor.screen.style.width=s;const i=(e*this.blockSize).toString();t.editor.screen.style.width=i,this.cleanMapAfterChangeSize()}cleanMap(){this.terrains=[],this.bushes=[],this.rocks=[],this.trees=[],this.walls=[]}cleanMapAfterChangeSize(){const e=this.size*this.blockSize;let t=this.terrains;for(let s=t.length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}t=this.trees;for(let s=t.length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}t=this.rocks;for(let s=t.length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}t=this.bushes;for(let s=t.length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}t=this.walls;for(let s=t.length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}}openMap(e){this.create(),this.changeSize(e.size);let t=0;for(const s of e.rocks)this.rocks.push(new o(t++,s.x,s.y));for(const s of e.trees)this.trees.push(new r(t++,s.x,s.y,s.angle));for(const s of e.bushes)this.bushes.push(new h(t++,s.x,s.y,s.angle));for(const s of e.rects)this.walls.push(new c(t++,s.x,s.y,s.width,s.height));for(const t of e.terrains)this.terrains.push(new a(t.type,t.x,t.y,t.size));this.cleanMapAfterChangeSize()}controller(){const e=this.myHtmlElements;e.editor.screen.addEventListener("mousemove",(t=>{const s=e.editor.screen.getBoundingClientRect();this.x=t.clientX+e.editor.screen.scrollLeft-s.left,this.y=t.clientY+e.editor.screen.scrollTop-s.top,e.editor.coordinates.innerText=`x: ${this.x} y: ${this.y}`})),e.editor.terrainImgs.addEventListener("click",(s=>{const i=e.editor.terrainImgs.children;for(let e=0;e<i.length;e++)i[e].style.borderColor=this.colors.blockFrame;const a=e.editor.objectImgs.children;for(let e=0;e<a.length;e++)a[e].style.borderColor=this.colors.blockFrame;switch(s.target.style.borderColor=this.colors.blockFrameActive,this.objectType=null,s.target){case e.editor.terrainWater:this.terrainType=t.Water;break;case e.editor.terrainGrass:this.terrainType=t.Grass;break;case e.editor.terrainWaterTriangle1:this.terrainType=t.WaterTriangle1;break;case e.editor.terrainWaterTriangle2:this.terrainType=t.WaterTriangle2;break;case e.editor.terrainWaterTriangle3:this.terrainType=t.WaterTriangle3;break;case e.editor.terrainWaterTriangle4:this.terrainType=t.WaterTriangle4}})),e.editor.objectImgs.addEventListener("click",(t=>{const s=e.editor.terrainImgs.children;for(let e=0;e<s.length;e++)s[e].style.borderColor=this.colors.blockFrame;const i=e.editor.objectImgs.children;for(let e=0;e<i.length;e++)i[e].style.borderColor=this.colors.blockFrame;switch(t.target.style.borderColor=this.colors.blockFrameActive,this.terrainType=null,t.target){case e.editor.objectBush:this.objectType="bush";break;case e.editor.objectRock:this.objectType="rock";break;case e.editor.objectTree:this.objectType="tree";break;case e.editor.objectRect:this.objectType="rect";break;case e.editor.objectHorizontalWall:this.objectType="horizontalWall";break;case e.editor.objectVerticalWall:this.objectType="verticalWall";break;case e.editor.objectDelete:this.objectType="delete"}})),e.editor.screen.addEventListener("click",(()=>{if(null!=this.getTerrainType()){const e=Math.floor(this.getX()/this.blockSize)*this.blockSize,s=Math.floor(this.getY()/this.blockSize)*this.blockSize;let i=-1;for(let t=0;t<this.terrains.length;t++){const a=this.terrains[t];if(a.x===e&&a.y===s){i=t;break}}-1!==i&&this.terrains.splice(i,1),this.getTerrainType()!==t.Grass&&this.terrains.push(new a(this.getTerrainType(),e,s,this.blockSize))}if(null!=this.getObjectType()){const e=Math.floor(360*Math.random());switch(this.getObjectType()){case"bush":this.bushes.push(new h(0,this.x-this.bush.size/2,this.y-this.bush.size/2,e));break;case"rock":this.rocks.push(new o(0,this.x-this.rock.size/2,this.y-this.rock.size/2));break;case"tree":this.trees.push(new r(0,this.x-this.tree.size/2,this.y-this.tree.size/2,e));break;case"rect":this.walls.push(new c(0,this.x-this.bush.size/2,this.y-this.bush.size/2,100,100));break;case"horizontalWall":this.walls.push(new c(0,this.x-this.horizontalWall.width/2,this.y-this.horizontalWall.height/2,this.horizontalWall.width,this.horizontalWall.height));break;case"verticalWall":this.walls.push(new c(0,this.x-this.verticalWall.width/2,this.y-this.verticalWall.height/2,this.verticalWall.width,this.verticalWall.height));break;case"delete":let t;const s=this;for(const e of s.rocks){const i=e;i.x<=s.getX()&&i.x+i.size>=s.getX()&&i.y<=s.getY()&&i.y+i.size>=s.getY()&&(t=i)}for(const e of s.walls){const i=e;i.x<=s.getX()&&i.x+i.width>=s.getX()&&i.y<=s.getY()&&i.y+i.height>=s.getY()&&(t=i)}for(const e of s.bushes){const i=e;i.x<=s.getX()&&i.x+i.size>=s.getX()&&i.y<=s.getY()&&i.y+i.size>=s.getY()&&(t=i)}for(const e of s.trees){const i=e;i.x<=s.getX()&&i.x+i.size>=s.getX()&&i.y<=s.getY()&&i.y+i.size>=s.getY()&&(t=i)}let i=-1;for(let e=0;e<this.rocks.length;e++)t==this.rocks[e]&&(i=e);-1!==i&&(this.rocks.splice(i,1),i=-1);for(let e=0;e<this.bushes.length;e++)t==this.bushes[e]&&(i=e);-1!==i&&(this.bushes.splice(i,1),i=-1);for(let e=0;e<this.trees.length;e++)t==this.trees[e]&&(i=e);-1!==i&&(this.trees.splice(i,1),i=-1);for(let e=0;e<this.walls.length;e++)t==this.walls[e]&&(i=e);-1!==i&&(this.walls.splice(i,1),i=-1)}}})),this.socket.on("openMapInEditor",(t=>{this.openMap(t),e.close(e.openMapMenu.main),e.open(e.editor.container)}))}}!function(e){e[e.Production=0]="Production",e[e.Localhost=1]="Localhost"}(i||(i={}));class A{constructor(){this.keys={w:!1,a:!1,s:!1,d:!1,e:!1,r:!1},this.mouse={x:0,y:0,left:!1,middle:!1,right:!1},this.playerAngle=0,this.appVariant="localhost"===window.location.hostname?i.Localhost:i.Production,this.myHtmlElements=new T,this.canvas=document.getElementsByTagName("canvas")[0],this.appVariant===i.Localhost?this.socket=io.connect("http://localhost:8000"):this.socket=io.connect(),this.serverClientSync=new G,this.editor=new P(this.myHtmlElements,this.socket),this.model=new x(this.mouse,this.socket,this.serverClientSync,this.myHtmlElements,this.editor),window.addEventListener("resize",(()=>{this.model.view.screenResize();const e=new Event("mousemove");this.canvas.dispatchEvent(e)})),window.addEventListener("beforeunload",(e=>{e.preventDefault(),e.returnValue=""})),this.keysController(),this.mouseController(),this.socketController(),this.menuController()}static run(){if(A.instance)throw new Error("Only one controller!");A.instance=new A}changePlayerName(){const e=this.myHtmlElements;let t=!1;e.mainMenu.name.value.length&&(t=!0,localStorage.setItem("playerName",e.mainMenu.name.value)),e.mainMenu.create.disabled=!t,e.mainMenu.maps.disabled=!t;let s=!1;e.mainMenu.games.value&&(s=!0);let i=!0;t&&s&&(i=!1),e.mainMenu.join.disabled=i,e.mainMenu.games.disabled=i}socketController(){const e=this.myHtmlElements;this.socket.on("debug",(e=>{console.log("debug:",e)})),this.socket.on("winner",(e=>{this.model.view.gameOver(e,!0)})),this.socket.on("loser",(e=>{this.model.view.gameOver(e,!1)})),this.socket.on("stopGame",(()=>{this.model.stop()})),this.socket.on("stopSpectate",((e,t)=>{this.model.view.gameOver(e,!0,t)})),this.socket.on("startGame",(t=>{this.model.map.openMap(t),this.model.gameStart(),e.close(e.lobbyMenu.main),setTimeout((()=>{e.close(e.hideGame)}),100)})),this.socket.on("playerId",(e=>{this.model.setPlayerId(e)})),this.socket.on("createGame",((t,s)=>{this.model.setGameId(t),e.close(e.mainMenu.main,e.lobbyMenu.forJoinPlayers),e.open(e.lobbyMenu.main,e.lobbyMenu.forCreatePlayer)})),this.socket.on("joinGame",((t,s)=>{this.model.setGameId(t),e.close(e.mainMenu.main,e.lobbyMenu.forCreatePlayer),e.open(e.lobbyMenu.main,e.lobbyMenu.forJoinPlayers)})),this.socket.on("leaveLobby",(()=>{this.model.setGameId(-1),e.close(e.lobbyMenu.main),e.open(e.mainMenu.main)})),this.socket.on("cancelLobby",(()=>{this.model.setGameId(-1),e.close(e.lobbyMenu.main),e.open(e.gameCanceledMenu.main)})),this.socket.on("updateListOpenGames",(t=>{e.mainMenu.games.innerHTML="";for(const s of t){const t=document.createElement("option");t.textContent=s.name+"'s game",t.setAttribute("value",s.index.toString()),e.mainMenu.games.appendChild(t)}t.length&&e.mainMenu.name.value.length?(e.mainMenu.games.disabled=!1,e.mainMenu.join.disabled=!1):(e.mainMenu.games.disabled=!0,e.mainMenu.join.disabled=!0)})),this.socket.on("listOfPlayers",(t=>{e.lobbyMenu.gameName.textContent=t[0]+"'s game",e.lobbyMenu.players.innerHTML="";for(const s of t){const t=document.createElement("li");t.textContent=s,e.lobbyMenu.players.appendChild(t)}})),this.socket.on("collisionPoints",((e,t,s)=>{this.model.collisionPoints.setData(e,t,s)})),this.socket.on("sendMap",(e=>{this.model.map.openMap(e)})),this.socket.on("mapSaved",(()=>{e.close(e.mapEditorMenu.main,e.editor.container),e.open(e.saveMapMenu.main),this.editor.close()})),this.socket.on("listOfMaps",(t=>{e.openMapMenu.maps.innerHTML="",e.mainMenu.maps.innerHTML="";for(const s of t){const t=document.createElement("option");t.setAttribute("value",s),t.textContent=s,e.mainMenu.maps.appendChild(t);const i=t.cloneNode(!0);e.openMapMenu.maps.appendChild(i)}})),this.socket.on("createPlayer",(e=>{e?this.model.setName(e):console.log("err: created player")})),this.socket.on("serverClientSync",((e,t)=>{const s=Date.now(),i=s-e,a=t-(s-i/2);this.serverClientSync.addData(i,a)})),this.socket.on("u",(e=>{this.model.snapshotManager.addSnapshot(e)}))}mouseController(){document.addEventListener("contextmenu",(function(e){e.preventDefault()})),document.addEventListener("mousedown",(function(e){2===e.which&&e.preventDefault()})),this.myHtmlElements.transparentLayer.addEventListener("mousemove",(e=>{if(!this.model.gameActive())return;null==e.x?(this.mouse.x=this.canvas.width/2,this.mouse.y=this.canvas.height/2):(this.mouse.x=e.x,this.mouse.y=e.y);const t=this.playerAngle;this.rotatePlayer(this.mouse.x,this.mouse.y),this.playerAngle!==t&&this.socket.emit("a",this.model.getGameId(),this.playerAngle)})),this.myHtmlElements.transparentLayer.addEventListener("mousedown",(e=>{if(!this.model.gameActive())return;this.mouse.left=!0;const t=new p(e.clientX,e.clientY),s=this.model.view.calculateServerPosition(t);this.socket.emit("m",this.model.getGameId(),"l",s)})),this.myHtmlElements.transparentLayer.addEventListener("mouseup",(e=>{this.model.gameActive()&&(this.mouse.left=!1,this.socket.emit("m",this.model.getGameId(),"-l"))}))}rotatePlayer(e,t){const s=this.canvas.width/2,i=this.canvas.height/2;let a=s-e,n=i-t;0===a&&(a=.1);let r=Math.abs(180*Math.atan(a/n)/Math.PI);e>=s&&t<i&&(this.playerAngle=r),e>=s&&t>=i&&(this.playerAngle=180-r),e<s&&t>=i&&(this.playerAngle=180+r),e<s&&t<i&&(this.playerAngle=360-r),this.playerAngle=Math.round(this.playerAngle),360===this.playerAngle&&(this.playerAngle=0)}keysController(){document.addEventListener("keydown",(e=>{if(27===e.which&&(this.model.gameActive()||this.model.getSpectate())&&(this.myHtmlElements.escFromGameMenu.main.style.display="block"),this.model.gameActive())switch(e.which){case 87:this.keys.w||this.socket.emit("c",this.model.getGameId(),"u"),this.keys.w=!0;break;case 65:this.keys.a||this.socket.emit("c",this.model.getGameId(),"l"),this.keys.a=!0;break;case 83:this.keys.s||this.socket.emit("c",this.model.getGameId(),"d"),this.keys.s=!0;break;case 68:this.keys.d||this.socket.emit("c",this.model.getGameId(),"r"),this.keys.d=!0;break;case 69:this.keys.e||this.socket.emit("c",this.model.getGameId(),"e"),this.keys.e=!0;break;case 82:this.keys.e||this.socket.emit("c",this.model.getGameId(),"re"),this.keys.r=!0;break;case 48:this.socket.emit("i",this.model.getGameId(),0);break;case 49:this.socket.emit("i",this.model.getGameId(),1);break;case 50:this.socket.emit("i",this.model.getGameId(),2);break;case 51:this.socket.emit("i",this.model.getGameId(),3);break;case 52:this.socket.emit("i",this.model.getGameId(),4);break;case 53:this.socket.emit("i",this.model.getGameId(),5);break;case 54:this.socket.emit("i",this.model.getGameId(),6);break;case 55:this.socket.emit("i",this.model.getGameId(),7);break;case 56:this.socket.emit("i",this.model.getGameId(),8)}})),document.addEventListener("keyup",(e=>{if(this.model.gameActive())switch(e.which){case 87:this.keys.w&&this.socket.emit("c",this.model.getGameId(),"-u"),this.keys.w=!1;break;case 65:this.keys.a&&this.socket.emit("c",this.model.getGameId(),"-l"),this.keys.a=!1;break;case 83:this.keys.s&&this.socket.emit("c",this.model.getGameId(),"-d"),this.keys.s=!1;break;case 68:this.keys.d&&this.socket.emit("c",this.model.getGameId(),"-r"),this.keys.d=!1;break;case 69:this.keys.e=!1;break;case 82:this.keys.r=!1}}))}menuController(){const e=this.myHtmlElements;localStorage.getItem("playerName")&&(e.mainMenu.name.value=localStorage.getItem("playerName"),this.changePlayerName()),e.escFromGameMenu.back.addEventListener("click",(()=>{e.escFromGameMenu.main.style.display="none"})),e.escFromGameMenu.leave.addEventListener("click",(()=>{e.escFromGameMenu.main.style.display="none",this.socket.emit("leaveGame",this.model.getGameId()),this.model.reset()})),e.gameOverMenu.back.addEventListener("click",(()=>{this.socket.emit("leaveGame",this.model.getGameId()),this.model.reset()})),e.gameOverMenu.spectate.addEventListener("click",(()=>{this.socket.emit("spectate",this.model.getGameId()),e.close(e.gameOverMenu.main),this.model.startSpectate()})),e.mapSizeMenu.ok.addEventListener("click",(()=>{this.editor.changeSize(parseInt(document.getElementById("mapSizeValue").value)),e.open(e.editor.container),e.close(e.mapSizeMenu.main)})),e.mapSizeMenu.back.addEventListener("click",(()=>{e.close(e.mapSizeMenu.main),this.editor.isActive()?e.open(e.mapEditorMenu.main):e.open(e.mapMenu.main)})),e.mapMenu.create.addEventListener("click",(()=>{this.editor.create(),e.close(e.mapMenu.main),e.open(e.mapSizeMenu.main)})),e.mapMenu.open.addEventListener("click",(()=>{e.close(e.mapMenu.main),e.open(e.openMapMenu.main)})),e.mapMenu.back.addEventListener("click",(()=>{e.close(e.mapMenu.main),e.open(e.mainMenu.main)})),e.openMapMenu.back.addEventListener("click",(()=>{e.close(e.openMapMenu.main),e.open(e.mapMenu.main)})),e.openMapMenu.ok.addEventListener("click",(()=>{const t=e.openMapMenu.maps.value;this.socket.emit("openMapInEditor",t)})),e.editor.openMenu.addEventListener("click",(()=>{e.open(e.mapEditorMenu.main)})),e.mapEditorMenu.back.addEventListener("click",(()=>{e.close(e.mapEditorMenu.main)})),e.mapEditorMenu.close.addEventListener("click",(()=>{e.close(e.mapEditorMenu.main,e.editor.container),e.open(e.mainMenu.main),this.editor.close()})),e.mapEditorMenu.save.addEventListener("click",(()=>{const t=this.editor.getMapData(),s=e.mapEditorMenu.name.value;this.model.isNameOk(s)?this.socket.emit("editorSaveMap",s,t):e.open(e.alertMenu.main)})),e.mapEditorMenu.changeSize.addEventListener("click",(()=>{e.close(e.mapEditorMenu.main),e.open(e.mapSizeMenu.main)})),e.saveMapMenu.back.addEventListener("click",(()=>{e.close(e.saveMapMenu.main),e.open(e.mainMenu.main)})),e.mainMenu.openEditor.addEventListener("click",(()=>{e.open(e.mapMenu.main),e.close(e.mainMenu.main)})),e.mainMenu.name.addEventListener("input",(()=>{this.changePlayerName()})),e.mainMenu.create.addEventListener("click",(()=>{if(e.mainMenu.name.value.length){const t=e.mainMenu.name.value,s=e.mainMenu.maps.value;this.model.isNameOk(t)?this.socket.emit("createGame",t,s):e.open(e.alertMenu.main)}})),e.mainMenu.join.addEventListener("click",(()=>{if(e.mainMenu.name.value.length&&e.mainMenu.games.value){const t=e.mainMenu.name.value,s=parseInt(e.mainMenu.games.value);this.model.isNameOk(t)?this.socket.emit("joinGame",t,s):e.open(e.alertMenu.main)}})),e.gameCanceledMenu.back.addEventListener("click",(()=>{e.close(e.gameCanceledMenu.main),e.open(e.mainMenu.main)})),e.mainMenu.controls.addEventListener("click",(()=>{e.open(e.controlsMenu.main),e.close(e.mainMenu.main)})),e.alertMenu.ok.addEventListener("click",(()=>{e.close(e.alertMenu.main)})),e.lobbyMenu.leave.addEventListener("click",(()=>{this.socket.emit("leaveLobby",this.model.getGameId())})),e.lobbyMenu.cancel.addEventListener("click",(()=>{this.socket.emit("cancelLobby",this.model.getGameId())})),e.lobbyMenu.start.addEventListener("click",(()=>{e.close(e.lobbyMenu.main),this.socket.emit("startGame",this.model.getGameId())})),e.controlsMenu.back.addEventListener("click",(()=>{e.open(e.mainMenu.main),e.close(e.controlsMenu.main)}))}}A.run(),console.log("Version: 1.0.1")})();
//# sourceMappingURL=app.js.map